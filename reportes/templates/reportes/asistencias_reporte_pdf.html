{% load dict_extras %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Reporte de Asistencias - Academia Musical</title>
    <style>
        @page { size: A4 landscape; margin: 1.2cm; }

        body { font-family: Arial, sans-serif; font-size: 10px; color: #000; margin: 0; padding: 0; }

        /* Encabezado sobrio */
        .header { text-align: center; margin-bottom: 10px; }
        .header h1 { font-size: 18px; margin: 0; }
        .header h2 { font-size: 12px; margin: 2px 0 0 0; font-weight: normal; }
        .separator { border-top: 1px solid #000; margin: 6px 0 10px 0; }

        /* Bloque de metadatos simple */
        .meta { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
        .meta td { padding: 3px 0; vertical-align: top; font-size: 9px; }
        .meta .label { font-weight: bold; width: 18%; }
        .meta .value { width: 32%; }

        /* Resumen simple en gris */
        .summary-stats { width: 100%; border-collapse: collapse; margin: 6px 0 10px 0; }
        .summary-stats td { border: 1px solid #000; padding: 5px; text-align: center; font-weight: bold; font-size: 9px; }

        /* Tabla de asistencias */
        thead { display: table-header-group; }
        tfoot { display: table-footer-group; }
        table { page-break-inside: auto; }
        tr { page-break-inside: avoid; page-break-after: auto; }

        .attendance-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .attendance-table th, .attendance-table td { border: 1px solid #000; padding: 4px; text-align: center; font-size: 8px; }
        .attendance-table th { background: #f5f5f5; font-weight: bold; }
        .attendance-table .student-info { text-align: left; font-size: 8px; }
        .row-even { background: #fafafa; }
        .row-odd  { background: #fff; }

        /* Estados: sin colores llamativos, solo letra */
        .estado-cell { font-size: 8px; font-weight: bold; }

        /* Leyenda minimalista */
        .legend { font-size: 7px; margin-top: 6px; }
        .legend-item { display: inline-block; margin-right: 12px; }

        .footer-info { text-align: center; font-size: 8px; margin-top: 10px; border-top: 1px solid #000; padding-top: 6px; }

        @media print {
            .meta td { font-size: 8px; }
            .summary-stats td { font-size: 8px; padding: 4px; }
            .attendance-table th, .attendance-table td { font-size: 7px; padding: 3px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Academia Musical</h1>
        <h2>Reporte de Asistencias</h2>
    </div>
    <div class="separator"></div>
    <table class="meta">
        <tr>
            <td class="label">Generado:</td>
            <td class="value">{{ fecha_generacion|date:"d/m/Y H:i" }}</td>
            <td class="label">Usuario:</td>
            <td class="value">{{ usuario_generador.get_full_name|default:usuario_generador.username }}</td>
        </tr>
        <tr>
            <td class="label">Período:</td>
            <td class="value">
                {% if periodo_inicio %}{{ periodo_inicio|date:"d/m/Y" }}{% endif %}
                {% if periodo_fin %} - {{ periodo_fin|date:"d/m/Y" }}{% endif %}
            </td>
            <td class="label">Estudiantes:</td>
            <td class="value">{{ total_estudiantes }}</td>
        </tr>
        <tr>
            <td class="label">Clase:</td>
            <td class="value">{% if clase_seleccionada %}{{ clase_seleccionada.curso.nombre }} - {{ clase_seleccionada.aula }}{% else %}Todas{% endif %}</td>
            <td class="label">Total Días:</td>
            <td class="value">{{ total_dias }}</td>
        </tr>
        <tr>
            <td class="label">Estado:</td>
            <td class="value">{% if estado_filtro %}{{ estado_filtro|title }}{% else %}Todos{% endif %}</td>
            <td class="label">Curso:</td>
            <td class="value">{% if curso_sel %}{{ curso_sel.nombre }}{% else %}Todos{% endif %}</td>
        </tr>
        <tr>
            <td class="label">Profesor:</td>
            <td class="value">{% if profesor_sel %}{{ profesor_sel.last_name }}, {{ profesor_sel.first_name }}{% else %}Todos{% endif %}</td>
            <td class="label">Estudiante:</td>
            <td class="value">{% if query_estudiante %}{{ query_estudiante }}{% else %}-{% endif %}</td>
        </tr>
    </table>

    <!-- Resumen de Estadísticas -->
    <table class="summary-stats">
        <tr>
            <td>
                Presentes<br>{{ total_presentes }} ({{ porcentaje_presentes }}%)
            </td>
            <td>
                Tardanzas<br>{{ total_tardanzas }}
            </td>
            <td>
                Ausentes<br>{{ total_ausentes }}
            </td>
            <td>
                Justificados<br>{{ total_justificados }}
            </td>
        </tr>
    </table>

    <!-- NUEVA: Tabla cruzada de asistencias -->
    {% if estudiantes_data %}
    <table class="attendance-table">
        <thead>
            <tr>
                <th>N°</th>
                <th class="student-info">Estudiante</th>
                <th class="student-info">Curso</th>
                {% for fecha in fechas_periodo %}
                <th class="date-header">{{ fecha|date:"d/m" }}</th>
                {% endfor %}
                <th>Asist. (P+T)</th>
            </tr>
        </thead>
        <tbody>
            {% for estudiante_id, data in estudiantes_data.items %}
            <tr class="{% cycle 'row-odd' 'row-even' %}">
                <td>{{ forloop.counter }}</td>
                <td class="student-info">
                    <strong>{{ data.estudiante.last_name }}, {{ data.estudiante.first_name }}</strong><br>
                    <small>{{ data.estudiante.cedula|default:"-" }}</small>
                </td>
                <td class="student-info">{{ data.curso }}</td>
                {% for fecha in fechas_periodo %}
                <td class="estado-cell {% with asistencia=data.asistencias_por_fecha|get_item:fecha %}{% if asistencia %}{% if asistencia.estado == 'PRESENTE' %}estado-presente{% elif asistencia.estado == 'TARDE' %}estado-tarde{% elif asistencia.estado == 'JUSTIFICADO' %}estado-justificado{% else %}estado-ausente{% endif %}{% else %}estado-ausente{% endif %}{% endwith %}">
                    {% with asistencia=data.asistencias_por_fecha|get_item:fecha %}
                        {% if asistencia %}
                            {% if asistencia.estado == 'PRESENTE' %}P
                            {% elif asistencia.estado == 'TARDE' %}T
                            {% elif asistencia.estado == 'JUSTIFICADO' %}J
                            {% else %}A{% endif %}
                        {% else %}
                            -
                        {% endif %}
                    {% endwith %}
                </td>
                {% endfor %}
                <td>{{ data.asistio_count }}/{{ total_dias }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Leyenda -->
    <div class="legend">
        <strong>Leyenda:</strong>
        <div class="legend-item">
            <span class="legend-box estado-presente"></span>P = Presente
        </div>
        <div class="legend-item">
            <span class="legend-box estado-tarde"></span>T = Tardanza
        </div>
        <div class="legend-item">
            <span class="legend-box estado-ausente"></span>A = Ausente
        </div>
        <div class="legend-item">
            <span class="legend-box estado-justificado"></span>J = Justificado
        </div>
        <div class="legend-item">- = Sin registro</div>
    </div>
    
    {% else %}
    <div class="no-data">
        <h3>No se encontraron registros</h3>
        <p>No hay asistencias que coincidan con los filtros seleccionados.</p>
    </div>
    {% endif %}

    <div class="footer-info">
        Academia Musical - Sistema de Gestión | Generado el {{ fecha_generacion|date:"d/m/Y H:i" }}
    </div>
</body>

</html>
